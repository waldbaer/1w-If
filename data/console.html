<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <title>1-Wire Interface</title>
  <link rel="stylesheet" href="/style.css">
  <script src="/js/menu.js"></script>
</head>

<body>
  <div id="title-container"></div>
  <div id="menu-container"></div>

  <h2>Log Monitor</h2>
  <pre id='log' style='background:#222;color:#BBB;padding:10px;height:60vh;overflow:auto;'></pre>

  <script>
    LoadTitle('title-container');
    LoadMenu('menu-container');

    let log = document.getElementById('log');

    let ws = new WebSocket(`ws://${location.host}`);
    //let ws = new WebSocket('ws://192.168.0.41');

    const colors = {
      S: '#888888',   // System - light grey, low importance messages
      V: '#AAAAAA',   // Verbose - very light grey, detailed information
      D: '#61AFEF',   // Debug - light blue, development information
      I: '#98C379',   // Info - light green, standard operational messages
      W: '#E5C07B',   // Warning - light yellow/orange, potential issues
      E: '#E06C75',   // Error - light red, actual errors
      F: '#FF1A1A'    // Fatal - bright red, critical errors
    };

    ws.onmessage = e => {
      const json = JSON.parse(e.data);

      if (json.LOG) {
        let log_content = json.LOG;
        const match = log_content.match(/(\d{2}:\d{2}:\d{2}\.\d{3}) \[(\w)\] (\[(.*)\] )?(.*)/);
        if (match) {
          const [, timestamp, loglevel, has_app, app, message] = match;
          if (app == undefined) {
            app = "<unknown>";
          }
          const color = colors[loglevel] || '#BBB';
          log.innerHTML += `<span style="color:${color}">${timestamp} [${loglevel}] ${("[" + app + "]").padEnd(15)} ${message}</span><br/>`
        } else {
          log.textContent += `JSON PARSE ERROR: ${log_content}`
        }

        log.scrollTop = log.scrollHeight;
      }
    };
  </script>
</body>

</html>
